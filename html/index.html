<!doctype html>
<html>
<head>
  <meta charset='utf-8'>
  <title>Load &amp; Save (Ajax) - Handsontable</title>

  <script src="js/common/jquery-1.9.0-min.js"></script>
  <script src="js/common/jquery-ui-1.9.2.min.js"></script>
  <link rel="stylesheet" href="css\jquery-ui\jquery-ui.css">

  <!-- Sidebar dependencies -->
        <link rel="stylesheet" href="css/sidebar/lib/fontello.css" />
        <link rel="stylesheet" href="css/sidebar/lib/normalize.css" />
        <link rel="stylesheet" href="css/sidebar/sidebar.css" />
  <!-- end Sidebar dependencies -->

  <!-- Handsontable dependencies-->
      <script src="js/handsontable/handsontable.full.js"></script>
      <link rel="stylesheet" media="screen" href="css/handsontable/handsontable.full.css">

      <!-- File below contains ajax function used by handsontable -->
      <script src="js/handsontable/helper.js"></script>

      <script src="js/handsontable/zeroclipboard/ZeroClipboard.js"></script>
  <!--end Handsontable dependencies -->

  <!-- jsPlumb dependencies -->
      <link rel="stylesheet" href="css/jsplumb/jsplumb.css">
      <!-- JS -->
      <script src="js/common/jquery-1.9.0-min.js"></script>
      <script src="js/common/jquery-ui-1.9.2.min.js"></script>
      <script src="js/jsplumb/external/jquery.ui.touch-punch-0.2.2.min.js"></script>
      <!-- support lib for bezier stuff -->
      <script src="js/jsplumb/lib/jsBezier-0.6.js"></script>
      <!-- event adapter -->
      <script src="js/jsplumb/lib/mottle-0.4.js"></script>
      <!-- geom functions -->
      <script src="js/jsplumb/lib/biltong-0.2.js"></script>
      <!-- jsplumb util -->
      <script src="js/jsplumb/src/util.js"></script>
      <script src="js/jsplumb/src/browser-util.js"></script>
      <!-- base DOM adapter -->
      <script src="js/jsplumb/src/dom-adapter.js"></script>
      <!-- main jsplumb engine -->
      <script src="js/jsplumb/src/jsPlumb.js"></script>
      <!-- endpoint -->
      <script src="js/jsplumb/src/endpoint.js"></script>
      <!-- connection -->
      <script src="js/jsplumb/src/connection.js"></script>
      <!-- anchors -->
      <script src="js/jsplumb/src/anchors.js"></script>
      <!-- connectors, endpoint and overlays  -->
      <script src="js/jsplumb/src/defaults.js"></script>
      <!-- bezier connectors -->
      <script src="js/jsplumb/src/connectors-bezier.js"></script>
      <!-- state machine connectors -->
      <script src="js/jsplumb/src/connectors-statemachine.js"></script>
      <!-- flowchart connectors -->
      <script src="js/jsplumb/src/connector-editors.js"></script>
      <!-- SVG renderer -->
      <script src="js/jsplumb/src/renderers-svg.js"></script>
      <!-- vml renderer -->
      <script src="js/jsplumb/src/renderers-vml.js"></script>
      <!-- common adapter -->
      <script src="js/jsplumb/src/base-library-adapter.js"></script>
      <!-- jquery jsPlumb adapter -->
      <script src="js/jsplumb/src/jquery.jsPlumb.js"></script>
      <!-- /JS -->
  <!-- end of jsPlumb dependencies -->

  <link rel="stylesheet" media="screen" href="css/main.css">

</head>
<body>

<div class="jsc-sidebar-content jsc-sidebar-pulled sidebar" style="z-index:999">
    <nav>
        <a href="#" class="icon-menu link-menu jsc-sidebar-trigger"></a>
        <h1 class="inline">Welcome to online PDP solver!</h1>
    </nav>
    <section>
        <div id="content_container" class="container">
            <p>
              <input type="file" id="pdp_points_filename" />

              <button name="load" id="load" class="hidden_until_file_choose">Load</button>
              <button name="save" id="save" class="hidden_until_file_choose">Save</button>
            </p>

            <div id="console" >
                Click "Load" to load data from server
            </div>

            <div class="demo perimeter-demo" id="points_container">
                <div class="shape pdp_point" data-shape="Circle" title="122"></div>
                <div class="shape pdp_point" data-shape="Circle" title="122"></div>
                <div class="shape pdp_point" data-shape="Circle" title="122"></div>
                <div class="shape pdp_point" data-shape="Circle" title="122"></div>
                <div class="shape pdp_point" data-shape="Circle" title="122"></div>
            </div>
            <script>
                jsPlumb.ready(function() {

                    _pointsContainer = jsPlumb.getInstance({
                        Connector:"StateMachine",
                        PaintStyle:{ lineWidth:3, strokeStyle:"#ffa500", "dashstyle":"2 4" },
                        Endpoint:[ "Dot", { radius:5 } ],
                        EndpointStyle:{ fillStyle:"#ffa500" },
                        Container:"perimeter-demo"
                    });

                    var _pdpPoints = jsPlumb.getSelector(".shape");
                    // make everything draggable
                    _pointsContainer.draggable(_pdpPoints);

                    // suspend drawing and initialise.
                    _pointsContainer.doWhileSuspended(function() {

                            var min = 100;
                            var max = 400;
                        // loop through them and connect each one to each other one.
                        for (var i = 0; i < _pdpPoints.length; i++) {
                            $(_pdpPoints[i]).css({'top':min + (max - min) * Math.random()});
                            $(_pdpPoints[i]).css({'left':min + (max - min) * Math.random()});
                            for (var j = i + 1; j < _pdpPoints.length; j++) {
                                _pointsContainer.connect({
                                    source:_pdpPoints[i],  // just pass in the current node in the selector for source
                                    target:_pdpPoints[j],
                                    // here we supply a different anchor for source and for target, and we get the element's "data-shape"
                                    // attribute to tell us what shape we should use, as well as, optionally, a rotation value.
                                    anchors:[
                                        [ "Perimeter", { shape:_pdpPoints[i].getAttribute("data-shape"), rotation:_pdpPoints[i].getAttribute("data-rotation") }],
                                        [ "Perimeter", { shape:_pdpPoints[j].getAttribute( "data-shape"), rotation:_pdpPoints[j].getAttribute("data-rotation") }]
                                    ]
                                });
                            }
                        }
                    });

                    jsPlumb.fire("jsPlumbDemoLoaded", _pointsContainer);
                });
            </script>

        </div>

    </section>

<!--     <section  style="background-color:blue">
    dsfadsfbr <br>  dfsd
    </section> -->

</div>

    <nav class="sidebar jsc-sidebar" id="jsi-nav" data-sidebar-options="">
        <div id="sidebar_container" class="container">
            <h1>Solution data</h1>
           <p>
             <label for="pdp_pairs_number">Pdp pairs:</label>
             <input id="pdp_pairs_number" class="numbersOnly" size="5">
          </p>
          <div id="example1"></div>

          <script>
            // var
            get = function(id) {
              return document.getElementById(id);
            },
            container = get('example1'),
            exampleConsole = get('console'),
            autosave = get('autosave'),
            load = get('load'),
            save = get('save');
            filenameContainer = get('pdp_points_filename');

            pickupRenderer = function(instance, td, row, col, prop, value, cellProperties) {
              Handsontable.renderers.TextRenderer.apply(this, arguments);
              td.style.borderColor = 'green';
              td.style.borderWidth = '2px';
            };
            deliveryRenderer = function(instance, td, row, col, prop, value, cellProperties) {
              Handsontable.renderers.TextRenderer.apply(this, arguments);
              td.style.backgroundColor = 'green';
            };

            function disabledRenderer(instance, td, row, col, prop, value, cellProperties) {
                Handsontable.renderers.TextRenderer.apply(this, arguments);
                td.style.backgroundColor = 'grey';
            }

            _hot = new Handsontable(container, {
              startRows: 4,
              startCols: 6,
              rowHeaders: true,
              colHeaders: true,
              minSpareRows: 0,
              colHeaders: ['X', 'Y', 'box x', 'box y', 'box z', 'box weight'],
              columnSorting: true,
              // contextMenu: true,
              contextMenuCopyPaste: {
                swfPath: 'js/handsontable/zeroclipboard/ZeroClipboard.swf'
              },
              cells: function (row, col, prop) {
                if (row < (this.instance.countRows() / 2) ) {
                  this.renderer = pickupRenderer;
                }
                else
                {
                   this.renderer = deliveryRenderer;
                   if (col > 1)
                   {
                      var cellProperties = {};
                      cellProperties.readOnly = true;
                      cellProperties.renderer = disabledRenderer;
                      return cellProperties;
                   }
                }
              },
              beforeChange: function (changes, source) {
                //changes[i][0] - row number
                //changes[i][1] - column number
                //changes[i][3] - new value

                // remove all non-number symbols
                 for (var i = changes.length - 1; i >= 0; i--) {
                    changes[i][3] = changes[i][3].replace(/[^0-9\.]/g,'');

                    // don't allow to fill box fields for delivery points
                    if ((changes[i][1] > 1) && changes[i][0] >= Math.floor(this.getData().length/2) ) // if changed cell column > 1 and this is delivery point, ..
                    {
                        changes[i][3] = '';
                    }
                 }
              },
              afterChange: function () {
                $("#pdp_pairs_number").spinner().spinner("value", Math.floor(this.getData().length/2));
             //   updatePdpPointPositions(container, ".pdp_point");
              },

            });


            loadJsonToTable = function(file) {
              if (file) {
                var reader = new FileReader();
                reader.onload = function() {
                    try {
                        var data = JSON.parse(this.result);

                        _lastLoadedData = data.data; // global var
                        exampleConsole.innerHTML = 'Data loaded';
                        _hot.loadData(_lastLoadedData.slice(0));
                    }
                    catch (e) {
                        exampleConsole.innerHTML = 'Data is incorrect. <br/>' + e;
                    }
                  };

                  reader.readAsText(file);
                }
            };

            loadJsonFromFileContainer = function(){
                loadJsonToTable(filenameContainer.files[0]);
                $('.hidden_until_file_choose').show();
            };

            Handsontable.Dom.addEvent(load, 'click', function(){
                loadJsonFromFileContainer();
            });

            Handsontable.Dom.addEvent(save, 'click', function() {
                // _hot.loadData([['', '', '', '', '', '']]);
              // // save all cell's data
              // ajax('json/save.json', 'GET', JSON.stringify({data: _hot.getData()}), function (res) {
              //   var response = JSON.parse(res.response);

              //   if (response.result === 'ok') {
              //     exampleConsole.innerHTML = 'Data saved';
              //   }
              //   else {
              //     exampleConsole.innerHTML = 'Save error';
              //   }
              // });
            });
          </script>
        </div>
    </nav>

    <script src="js/sidebar/sidebar.js"></script>

    <script>

        $(function() {
            $('#jsi-nav').sidebar({
                trigger: '.jsc-sidebar-trigger',
                scrollbarDisplay: true
            });

            $('#api-pull').on('click', function (e) {
                e.preventDefault();
                $('#jsi-nav').data('sidebar').push();
            });
            $('#api-push').on('click', function (e) {
                e.preventDefault();
                $('#jsi-nav').data('sidebar').pull();
            });

            // open sidebar at the begin
            $('#jsi-nav').data('sidebar').push();
        });
    </script>


    <script>
        // remove all non-numbers from all elements with class 'numbersOnly'
        jQuery('.htInvalid').keyup(function () {
            this.value = this.value.replace(/[^0-9\.]/g,'');
        });

        $("#pdp_pairs_number").spinner().spinner("value", 2);

        $('#pdp_points_filename').on("change", function(){ loadJsonFromFileContainer(); });
    </script>

    <script>
        $("#pdp_pairs_number").spinner({
            min: 2,
            change: function (event, ui) {
                var pairCount = parseInt($("#pdp_pairs_number").spinner().spinner("value"));
                var data = (typeof _lastLoadedData == 'undefined') ? [] : _lastLoadedData;

                var emptyRow = ['', '', '', '', '', ''];

                // new data is N (pairCount) first pickups and N first deliveries (if they don't exist in loaded data, leave them empty)
                var newData = [];
                for (var i = 0; i < pairCount; i++)
                {
                    // if pair number increased, we try to reuse existing PDP points
                    // i.g., if number was increased from 3 to 5, we leave already loaded 3 points
                    // BUT we force new PDP points (last 2 points in example) to be empty. This is why we check 'data[data.length/2 + i]'
                    newData.push(((typeof data[i] == 'undefined') || (typeof data[data.length/2 + i] == 'undefined')) ? emptyRow : data[i]);
                }
                for (var i = 0; i < pairCount; i++)
                {
                    newData.push((typeof data[data.length/2 + i] == 'undefined') ? emptyRow : data[data.length/2 + i]);
                }
                _hot.loadData(newData);
            }
        });
    </script>
    <script>
        function updatePdpPointPositions(handsontableSelector, pointsSelector) {
            table = $(handsontable);
            points = $(pointsSelector);

        }
    </script>
</body>
</html>